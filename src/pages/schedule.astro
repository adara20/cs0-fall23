---
import Layout from '../layouts/Layout.astro';
import { timeline, schedule } from '../data/schedule.ts';

// Convert "9:00 AM" → minutes since midnight
function toMinutes(time: string): number {
  const [timePart, period] = time.split(' ');
  let [h, m] = timePart.split(':').map(Number);
  if (period === 'PM' && h !== 12) h += 12;
  if (period === 'AM' && h === 12) h = 0;
  return h * 60 + m;
}

const SLOT_H   = 48;  // px per 30-min slot
const START_MIN = toMinutes(timeline[0]);
const TOTAL_H   = (timeline.length) * SLOT_H;

function eventStyle(start: string, end: string): string {
  const top    = ((toMinutes(start) - START_MIN) / 30) * SLOT_H;
  const height = ((toMinutes(end)   - toMinutes(start)) / 30) * SLOT_H;
  return `top:${top}px; height:${height}px;`;
}

function eventColor(name: string): string {
  const n = name.toLowerCase();
  if (n.includes('lab'))            return 'bg-violet-600 hover:bg-violet-700';
  if (n.includes('career'))         return 'bg-emerald-600 hover:bg-emerald-700';
  if (n.includes('office hours'))   return 'bg-blue-600 hover:bg-blue-700';
  return 'bg-slate-700 hover:bg-slate-800'; // lecture
}

function eventDotColor(name: string): string {
  const n = name.toLowerCase();
  if (n.includes('lab'))            return 'bg-violet-500';
  if (n.includes('career'))         return 'bg-emerald-500';
  if (n.includes('office hours'))   return 'bg-blue-500';
  return 'bg-slate-500';
}

const legend = [
  { label: 'Lecture',      color: 'bg-slate-700'   },
  { label: 'Lab',          color: 'bg-violet-600'  },
  { label: 'Office Hours', color: 'bg-blue-600'    },
  { label: 'Career OH',    color: 'bg-emerald-600' },
];
---

<Layout title="Schedule">

  <div class="mb-8 pb-6 border-b border-slate-200">
    <h1 class="text-3xl font-bold tracking-tight text-slate-900 mb-2">Weekly Schedule</h1>
    <p class="text-slate-500 mb-4">All course meetings, office hours, and labs.</p>
    <!-- Legend -->
    <div class="flex flex-wrap gap-4">
      {legend.map(({ label, color }) => (
        <span class="flex items-center gap-2 text-xs text-slate-600">
          <span class={`w-3 h-3 rounded ${color} shrink-0`}></span>
          {label}
        </span>
      ))}
    </div>
  </div>

  <!-- ── Mobile list view (hidden on md+) ─────────────────────────── -->
  <div class="md:hidden space-y-6">
    {schedule.filter(day => day.events.length > 0).map(day => (
      <div>
        <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-widest mb-3 pb-2 border-b border-slate-200">
          {day.name}
        </h3>
        <div class="space-y-3">
          {day.events.map(event => (
            <div class="flex items-start gap-3 bg-white rounded-lg border border-slate-200 px-4 py-3">
              <span class={`w-2.5 h-2.5 rounded-full mt-1 shrink-0 ${eventDotColor(event.name)}`}></span>
              <div class="min-w-0 flex-1">
                {event.url ? (
                  <a
                    href={event.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-sm font-semibold text-slate-800 hover:text-blue-600 transition-colors"
                  >
                    {event.name}
                  </a>
                ) : (
                  <span class="text-sm font-semibold text-slate-800">{event.name}</span>
                )}
                {event.who && <p class="text-xs text-slate-500 mt-0.5">{event.who}</p>}
                <p class="text-xs text-slate-400 mt-0.5 font-mono">{event.start} – {event.end}</p>
              </div>
            </div>
          ))}
        </div>
      </div>
    ))}
  </div>

  <!-- ── Desktop grid view (hidden below md) ───────────────────────── -->
  <div class="hidden md:block bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <div style={`min-width: ${schedule.length * 140 + 72}px`}>

        <!-- Day headers -->
        <div class="grid border-b border-slate-200" style={`grid-template-columns: 72px repeat(${schedule.length}, 1fr)`}>
          <div class="border-r border-slate-100 bg-slate-50"></div>
          {schedule.map(day => (
            <div class="px-3 py-3 text-center text-sm font-semibold text-slate-700 border-r border-slate-100 last:border-r-0 bg-slate-50">
              {day.name}
            </div>
          ))}
        </div>

        <!-- Time grid -->
        <div class="grid relative" style={`grid-template-columns: 72px repeat(${schedule.length}, 1fr); height:${TOTAL_H}px`}>

          <!-- Time labels -->
          <div class="border-r border-slate-100">
            {timeline.map((time, i) => (
              <div
                class="absolute flex items-start justify-end pr-3 pt-1 w-[72px]"
                style={`top:${i * SLOT_H}px; height:${SLOT_H}px`}
              >
                <span class="text-[10px] text-slate-400 whitespace-nowrap leading-none">{time}</span>
              </div>
            ))}
          </div>

          <!-- Day columns -->
          {schedule.map((day, di) => (
            <div
              class="relative border-r border-slate-100 last:border-r-0"
              style={`height:${TOTAL_H}px`}
            >
              <!-- Hour lines -->
              {timeline.map((_, i) => (
                <div
                  class={`absolute w-full ${i % 2 === 0 ? 'border-t border-slate-200' : 'border-t border-slate-100'}`}
                  style={`top:${i * SLOT_H}px`}
                ></div>
              ))}

              <!-- Events -->
              {day.events.map(event => (
                <div
                  class={`absolute left-1 right-1 rounded-lg text-white transition-colors cursor-default ${eventColor(event.name)}`}
                  style={eventStyle(event.start, event.end)}
                >
                  {event.url ? (
                    <a
                      href={event.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="flex flex-col h-full px-2 py-1.5 overflow-hidden"
                    >
                      <span class="font-semibold text-[11px] leading-tight line-clamp-2">{event.name}</span>
                      {event.who && <span class="text-[10px] opacity-80 truncate mt-0.5">{event.who}</span>}
                      <span class="text-[10px] opacity-70 mt-auto">{event.start}–{event.end}</span>
                    </a>
                  ) : (
                    <div class="flex flex-col h-full px-2 py-1.5 overflow-hidden">
                      <span class="font-semibold text-[11px] leading-tight line-clamp-2">{event.name}</span>
                      {event.who && <span class="text-[10px] opacity-80 truncate mt-0.5">{event.who}</span>}
                      <span class="text-[10px] opacity-70 mt-auto">{event.start}–{event.end}</span>
                    </div>
                  )}
                </div>
              ))}
            </div>
          ))}

        </div>
      </div>
    </div>
  </div>
  </div><!-- closes hidden md:block grid wrapper -->

</Layout>
